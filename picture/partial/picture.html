{{- $img := resources.Get .img }}
{{- if (not $img) }}
    {{- errorf "Could not load: %s" .img }}
{{- end }}
{{- $scratch := newScratch }}
{{- if (and .width .height) }}
    {{- $width := .width }}
    {{- $height := .height }}
    {{- $scratch.Set "resize" (printf "%dx%d" $width $height) }}
    {{- if .versions }}
        {{- range $version := (split .versions ",") }}
            {{- $scratch.Set (printf "resize%sx" $version) (printf "%0.0fx%0.0f" (mul $width (float $version)) (mul $height (float $version))) }}
        {{- end }}
    {{- end }}
{{- else if .width }}
    {{- $width := .width }}
    {{- $scratch.Set "resize" (printf "%dx" $width) }}
    {{- if .versions }}
        {{- range $version := (split .versions ",") }}
            {{- $scratch.Set (printf "resize%sx" $version) (printf "%0.0fx" (mul $width (float $version))) }}
        {{- end }}
    {{- end }}
{{- else if .height }}
    {{- $height := .height }}
    {{- $scratch.Set "resize" (printf "x%d" $height) }}
    {{- if .versions }}
        {{- range $version := (split .versions ",") }}
            {{- $scratch.Set (printf "resize%sx" $version) (printf "x%0.0f" (mul $height (float $version))) }}
        {{- end }}
    {{- end }}
{{- else }}
    {{- $scratch.Set "resize" (printf "%dx%d" $img.Width $img.Height) }}
{{- end }}
<picture>
{{- if (and (not .disablewebp) hugo.IsExtended) }}
    {{- $opts := "webp" }}
    {{- if .anchor }}
        {{- $opts = printf "%s %s" $opts .anchor }}
    {{- end }}
    {{- if .fit }}
    <source srcset="{{ ($img.Fit (printf "%s %s" ($scratch.Get "resize") "webp")).RelPermalink }}{{ if .versions }}{{ range $version := (split .versions ",") }}, {{ ($img.Fit (printf "%s %s" ($scratch.Get (printf "resize%sx" $version)) "webp")).RelPermalink }} {{ printf "%sx" $version }}{{ end }}{{ end }}" type="image/webp">
    {{- else if .fill }}
    <source srcset="{{ ($img.Fill (printf "%s %s" ($scratch.Get "resize") $opts)).RelPermalink }}{{ if .versions }}{{ range $version := (split .versions ",") }}, {{ ($img.Fill (printf "%s %s" ($scratch.Get (printf "resize%sx" $version)) $opts)).RelPermalink }} {{ printf "%sx" $version }}{{ end }}{{ end }}" type="image/webp">
    {{- else if .crop }}
    <source srcset="{{ ($img.Crop (printf "%s %s" ($scratch.Get "resize") $opts)).RelPermalink }}{{ if .versions }}{{ range $version := (split .versions ",") }}, {{ ($img.Crop (printf "%s %s" ($scratch.Get (printf "resize%sx" $version)) $opts)).RelPermalink }} {{ printf "%sx" $version }}{{ end }}{{ end }}" type="image/webp">
    {{- else }}
    <source srcset="{{ ($img.Resize (printf "%s %s" ($scratch.Get "resize") "webp")).RelPermalink }}{{ if .versions }}{{ range $version := (split .versions ",") }}, {{ ($img.Resize (printf "%s %s" ($scratch.Get (printf "resize%sx" $version)) "webp")).RelPermalink }} {{ printf "%sx" $version }}{{ end }}{{ end }}" type="image/webp">
    {{- end }}
{{- end }}
{{- with .svg }}
    {{- $svg := resources.Get . }}
    {{- if hugo.IsProduction }}
        {{- $svg = $svg | minify | fingerprint }}
    {{- end }}
    <source srcset="{{ $svg.RelPermalink }}" type="image/svg+xml">
{{- end }}
{{- $opts := "" }}
{{- if .anchor }}
    {{- $opts = printf "%s %s" $opts .anchor }}
{{- end }}
{{- if .fit }}
    <img {{ with .class }}class="{{ . }}" {{ end }}{{ with .alt }}alt="{{ . }}" {{ end }} src="{{ ($img.Fit (printf "%s" ($scratch.Get "resize"))).RelPermalink }}{{ if .versions }}{{ range $version := (split .versions ",") }}, {{ ($img.Fit (printf "%s" ($scratch.Get (printf "resize%sx" $version)))).RelPermalink }} {{ printf "%sx" $version }}{{ end }}{{ end }}">
{{- else if .fill }}
    <img {{ with .class }}class="{{ . }}" {{ end }}{{ with .alt }}alt="{{ . }}" {{ end }} src="{{ ($img.Fill (printf "%s %s" ($scratch.Get "resize") $opts)).RelPermalink }}{{ if .versions }}{{ range $version := (split .versions ",") }}, {{ ($img.Fill (printf "%s %s" ($scratch.Get (printf "resize%sx" $version) $opts))).RelPermalink }} {{ printf "%sx" $version }}{{ end }}{{ end }}">
{{- else if .crop }}
    <img {{ with .class }}class="{{ . }}" {{ end }}{{ with .alt }}alt="{{ . }}" {{ end }} src="{{ ($img.Crop (printf "%s %s" ($scratch.Get "resize") $opts)).RelPermalink }}{{ if .versions }}{{ range $version := (split .versions ",") }}, {{ ($img.Crop (printf "%s %s" ($scratch.Get (printf "resize%sx" $version) $opts))).RelPermalink }} {{ printf "%sx" $version }}{{ end }}{{ end }}">
{{- else }}
    <img {{ with .class }}class="{{ . }}" {{ end }}{{ with .alt }}alt="{{ . }}" {{ end }} src="{{ ($img.Resize (printf "%s" ($scratch.Get "resize"))).RelPermalink }}{{ if .versions }}{{ range $version := (split .versions ",") }}, {{ ($img.Resize (printf "%s" ($scratch.Get (printf "resize%sx" $version)))).RelPermalink }} {{ printf "%sx" $version }}{{ end }}{{ end }}">
{{- end }}
    
</picture>